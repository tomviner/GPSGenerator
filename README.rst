GPS tracking simulation for a Courier-Workers coordination
==========================================================

Introduction
-----------------
This a small simulator for generating gps coordinates, simulating a fleet of couriers or workers within big cities.

Objective
-------------
The main objective for this script is to have a flexible, easy to use and customizable stream of gps corrdinates.

Motivation
---------------
I need this tool for testing database storing of a big stream of gps tracking.
This is for personal use. I am considering transforming this repo in a small library agnostic to databases and personal data structures.

Proof of concept
------------------
Why store raw gps tracks inline if we can process them with some structure?
Structure the data first! This is the main goal. It will allow us to gain two very important goals:

> **Release-the-database:**  With the purpose of not hitting the database for writing, even if there is a write only master (postgres) lets design something that will allow us to scale the system from the beginning.
The intention of this is to save in a redis server de data flow generated by the couriers. Similar to a buffer. And collect them in a bulk process (worker, for example celery) when the monitoring system says it is better.

> **Storing some structured data in memory(redis):**  This will give us some realtime, observable state. ( ok realtime is an illusion in networked architectures like this ) This means we can query the redis about active deliveries, visualize them in a frontend(map) and track the real situation and location of the couriers without hitting the database.

**possible disadvantages**

-  Delaying disk writes in the database could be tricky, doing it in a bulk process can cause an overhead in disk writes. It is necessary to schedule this task in many small steps. Doing this in small hours could recommendable. It is possible that already exists a redis-potgresql syncing solution or using redis as a cache layer for postgres. .. (I need further study)
·· Interesting link: https://github.com/pg-redis-fdw/redis_fdw

-  Redis itself: . If the server dies or there is a network problem, storing a big dataflow in redis could be dangerous. We can have issues with data integrity. A Master-slave replication with a falldown detection could be the solution. Here, the key is the correct shceduling of workers that will collect the data to de database.

Requirements
-------------------------------

THE SCRIPT REQUIRES REDIS 3.2.0 version.  RUNING  !!!!

Create a virtualenv, and pip install -r requirements.txt



Implementation specifics
-------------------------------
**PREMISES**

· Each city has N number of Worker-Couriers.

· Each worker drives at a constant velocity, N number of hours, without stopping.

· Workers have always, a state [free, to provider, to customer]

· There is a Task ID for every transaction, when the Worker goes to Free in the cycle again, Task id Zeroes = 0, when the worker goes on duty again, he adquires, a new task number(like in a database sequence)

· So Worker id with task 0 is a discontinued line, marking the route he was off-dutty.(was free)

· All the workers start their route in the same spot.

· Each Simulation has a transmit rate, in seconds, is the rate every trakers sends its data, default is 15s.

Script use
-------------------------------

::

    $ python gpsgen.py --help
    usage: gpsgen [-h] [-nw NWORKERS] [-s SPEED] [-hs HOURS_SHIFT]
              [-tr TRANSMIT_RATE] [-d START_DATE] [-j] [-pj] [--version]
              {live,file,both}

    GPS Stream generator

    positional arguments:
      {live,file,both}      Select a type of simulation to execute

    optional arguments:
      -h, --help            show this help message and exit
      -nw NWORKERS, --nworkers NWORKERS
                        Number of Workers per city.
                        Unit: int
                        Default: 600
      -s SPEED, --speed SPEED
                        Speed workers are continously moving
                        Unit: m/s
                        Default: 13.8 m/s
      -hs HOURS_SHIFT, --hours-shift HOURS_SHIFT
                        Hours per shift, the worker drives
                        Unit: int
                        Default: 24
      -tr TRANSMIT_RATE, --transmit-rate TRANSMIT_RATE
                        GPS tracking transmit rate in seconds
                        Unit: seconds
                        Default: 15 s
      -d START_DATE, --start-date START_DATE
                        Start date for the simulation
                        Format: YYYY-MM-DD
                        Default: NOW
      -j, --json            Write the file in json format compressed
      -pj, --pretty-json    Write the file in json format
                        Indented 4 spaces
      --version             show program's version number and exit


Basically there are three ways to run the script [live | file | both ] 

If a file in involved, it can be generated in three ways [ sequential | json | pretty-json ] data.dat and data.json respectively 

**Note** Generated files could be huge! A smart editor will be nedded 

I use to cat | grep de normal sequential file like this: 


cat data.data | grep LON:12:936     <- this means filter the LONDON worker with id 12 and task number 936  


::

  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1587829164872535, lon=51.576935836732005)] [<TIME>: 2016-08-08 11:57:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16135913578442249, lon=51.57546404902187)] [<TIME>: 2016-08-08 11:57:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16426781443343386, lon=51.57476097762369)] [<TIME>: 2016-08-08 11:58:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16395603987800655, lon=51.57544567555702)] [<TIME>: 2016-08-08 11:58:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16304439979212024, lon=51.57360330734573)] [<TIME>: 2016-08-08 11:58:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16187637782667239, lon=51.57174856830581)] [<TIME>: 2016-08-08 11:58:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16437503191184027, lon=51.57138061608395)] [<TIME>: 2016-08-08 11:59:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16667298334667927, lon=51.571914199895836)] [<TIME>: 2016-08-08 11:59:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1671686932041156, lon=51.571497320913686)] [<TIME>: 2016-08-08 11:59:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.17002859429902487, lon=51.573379814745444)] [<TIME>: 2016-08-08 11:59:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1695335993086108, lon=51.57239838720787)] [<TIME>: 2016-08-08 12:00:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1689283759371598, lon=51.571127430217196)] [<TIME>: 2016-08-08 12:00:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16645468190058565, lon=51.571120152098096)] [<TIME>: 2016-08-08 12:00:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.164442573883905, lon=51.57017633937639)] [<TIME>: 2016-08-08 12:00:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16153974767273824, lon=51.56963488352319)] [<TIME>: 2016-08-08 12:01:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1631734731265174, lon=51.56916176381099)] [<TIME>: 2016-08-08 12:01:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1602133455294312, lon=51.570236066176484)] [<TIME>: 2016-08-08 12:01:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16079319065919231, lon=51.5687723734687)] [<TIME>: 2016-08-08 12:01:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16033204950968694, lon=51.567071024388135)] [<TIME>: 2016-08-08 12:02:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1584837739982246, lon=51.5665081136416)] [<TIME>: 2016-08-08 12:02:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1590683450536693, lon=51.56689248693348)] [<TIME>: 2016-08-08 12:02:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.16095412863552871, lon=51.56582423648692)] [<TIME>: 2016-08-08 12:02:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToProvider(odds=2, code=1, name='to_provider')] [<COORD>:Coord(lat=-0.1629860766447026, lon=51.56696608073687)] [<TIME>: 2016-08-08 12:03:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16457983609929122, lon=51.56661920690889)] [<TIME>: 2016-08-08 12:03:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1628102958367845, lon=51.56761184708433)] [<TIME>: 2016-08-08 12:03:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16198174306436888, lon=51.56639329195612)] [<TIME>: 2016-08-08 12:03:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16448959926390777, lon=51.56673422785085)] [<TIME>: 2016-08-08 12:04:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1664429052175198, lon=51.56748373223237)] [<TIME>: 2016-08-08 12:04:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16929718629440266, lon=51.56896381799841)] [<TIME>: 2016-08-08 12:04:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1679433313666356, lon=51.56901177206122)] [<TIME>: 2016-08-08 12:04:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1674783390573601, lon=51.56949720694524)] [<TIME>: 2016-08-08 12:05:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16793571142145106, lon=51.57081563259164)] [<TIME>: 2016-08-08 12:05:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16522408244136605, lon=51.57233778803376)] [<TIME>: 2016-08-08 12:05:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16701536853844712, lon=51.57169193539892)] [<TIME>: 2016-08-08 12:05:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16746953270224912, lon=51.57065190782533)] [<TIME>: 2016-08-08 12:06:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16541229504665284, lon=51.571771439021944)] [<TIME>: 2016-08-08 12:06:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16672297924635957, lon=51.5723910457318)] [<TIME>: 2016-08-08 12:06:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16774673990277647, lon=51.57330088500786)] [<TIME>: 2016-08-08 12:06:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1655345102033367, lon=51.5733894234253)] [<TIME>: 2016-08-08 12:07:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16638768528752598, lon=51.57205286273066)] [<TIME>: 2016-08-08 12:07:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1687996534162679, lon=51.570649857760046)] [<TIME>: 2016-08-08 12:07:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16940449715303896, lon=51.570850106709045)] [<TIME>: 2016-08-08 12:07:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16684403935988523, lon=51.57154989746134)] [<TIME>: 2016-08-08 12:08:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16409176182498275, lon=51.572063179712764)] [<TIME>: 2016-08-08 12:08:19.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.16555768495289955, lon=51.57390961240046)] [<TIME>: 2016-08-08 12:08:34.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1684475792316974, lon=51.57491881742156)] [<TIME>: 2016-08-08 12:08:49.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.17103763117067008, lon=51.576543788428765)] [<TIME>: 2016-08-08 12:09:04.509922]
  [<STEP> for LON:12:936] [<ACTION>:ToCustomer(odds=2, code=2, name='to_customer')] [<COORD>:Coord(lat=-0.1733063261793463, lon=51.576370048491505)] [<TIME>: 2016-08-08 12:09:19.509922]

The live mod writes directly the dataset in redis
More examples:
::
    python gpsgen.py both --json -nw 300 -hs 8
        live stream to redin AND write a json file , Number of workers per city: 300, hours per shift 8
        
    python gpsgen.py live --transmit-rate 20 -nw 600 --hours-shift 10
        live stream to redis at a transmit rate of 20s , Number of workers per city: 600, hours per shift 10 

Why not TDD
-------------------
I thought that python generators, coroutines and a scheduler were the most apropiate solution, for solving the problem. However, I really did not know how deep this rabbithole could go so, I decided not to do tdd this time. This script is a a proof of concept. I will rebuild this with tests, when i really know how to do it.

Performance Issues
--------------------------- 
I wanted a small memory footprint script, that is why I decided to do it with generators. On the one hand, the memory use is amazingly low. On the other hand, the cpu use is very intensive, something very normal in this kind of scripts(python).

Edit** I found something remarkable, once coroutines are created, and testing it with a contant flow of generated data. Memory footprint of the all machinery goes stable, constant in 24,8 MB, due to the big dataflow stream is generating, this is beyond all my expectations!

Speed Issues
------------------
This script generates a really big stream. I decided to implemente this generator and scheduler trick, to simulate some "concurrency", and have thorough control of the simulation, in one thread. That is why this script goes slow.


Extending to new cities 
-----------------------------
You need to find the city tag in http://epsg.io/4901    (Paris)
and extend the dictionary is harcoded in the begining of the script

::
  CITIES = {
          "LON": {
              "name": "LONDON",
              "initial_point": Coord(-0.1202201, 51.517235),
              "proj_map": "epsg:27700"
          },
          "MAD": {
              "name": "MADRID",
              "initial_point": Coord(-3.707429, 40.415369),
              "proj_map": "epsg:2062"
          },
          "PAR": {
              "name": "PARIS",
              "initial_point": Coord(2.294479, 48.858231),
              "proj_map": "epsg:4901"
          }
  }
  




